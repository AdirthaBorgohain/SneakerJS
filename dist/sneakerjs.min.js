angular.module("SneakerJS",[]),angular.module("SneakerJS").factory("SneakerModel",["$q","SnjsCollection","SnjsSingleton","SnjsParentChildRelationship","SnjsManyToManyRelationship",function(e,t,n,i,o){var r=function(r,a){var _=this;_.__db=r,_.__loadQuery=a||function(){return r.allDocs({include_docs:!0,attachments:!1})},_.__containers={},_.__dbDocumentTypeLoaders={},_.__lastPromiseInQueue=e.when(),_.__relationshipDefinitionFunctions={},_.__dataReady=void 0,_.changeCount=0,_.dataReady=function(){return void 0===_.__dataReady&&(_.__dataReady=_.__initializeModel()),_.__dataReady},_.reload=function(){return _.__dataReady=void 0,angular.forEach(_.__containers,function(e){e.clear()}),_.dataReady()},_.printInfo=function(){angular.forEach(_.__containers,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("db."+e.ModelFunctionName)})})},_.collection=function(e,n,i){var o=new t(_.__db,e,n,i);return _.__registerContainer(o),o},_.singleton=function(e,t){var i=new n(_.__db,e,t);return _.__registerContainer(i),i},_.oneToMany=function(e,t,n){_.__ensureCollectionsExist([e,t]);var o=_.__containers[e],r=_.__containers[t],a=new i(_.__db,o,r,n);return _.__registerContainer(a)},_.manyToMany=function(e,t,n){_.__ensureCollectionsExist([e,t]);var i=_.__containers[e],r=_.__containers[t];return container=new o(_.__db,i,r,n),_.__registerContainer(container)},_.__ensureCollectionsExist=function(e){angular.forEach(e,function(e){if(void 0===_.__containers[e])throw'Failed to create relationship, container not found: "'+e+'" '})},_.__registerContainer=function(e){var t=e.name;if(void 0!==_.__containers[t])throw"Trying to create containers with name: "+t+" on model but it already exists.";return _.__containers[t]=e,_.__registerDocumentTypeLoader(e),_.__createAccessFunctions(e),e},_.saveItem=function(t){return _.changeCount++,e.when(_.__containers[t.type].saveItem(t))},_.deleteItem=function(t){return _.changeCount++,e.when(_.__containers[t.type].deleteItem(t))},_.__createAccessFunctions=function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(t){var n,i=t.ModelFunctionName;if(n=t.queuedPromise?_.__getQueuedFunction(e,t.containerFunction):_.__getNonQueuedFunction(e,t.containerFunction),void 0!==_[i])throw"Container "+e.name+" trying to create function "+i+" on model but it already exists.";_[i]=n})},_.__getNonQueuedFunction=function(e,t){return function(){return t.apply(e,arguments)}},_.__getQueuedFunction=function(t,n){return function(){var i=arguments,o=e.defer();return _.__lastPromiseInQueue.then(function(){_.__lastPromiseInQueue=n.apply(t,i),_.__lastPromiseInQueue.then(function(e){_.changeCount++,o.resolve(e)})}),o.promise}},_.__registerDocumentTypeLoader=function(e){var t=e.dbDocumentType;if(void 0!==t){if(t in _.__dbDocumentTypeLoaders){_.__dbDocumentTypeLoaders[t];throw'More than one container attempting to register database document type: "'+t+'".'}_.__dbDocumentTypeLoaders[t]=e}},_.__initializeModel=function(){return _.__loadQuery().then(function(e){return angular.forEach(e.rows,function(e){_.__addDocumentToCollection(e.doc)}),_.__postInitialLoading(),e.rows.length})["catch"](function(e){console.log(e)})},_.__addDocumentToCollection=function(e){var t=e.type;if(t){var n=_.__dbDocumentTypeLoaders[t];n?n.loadDocumentFromDb(e,t):(console.log(e),console.log('Could not load document "'+e._id+'" as type was not recognised ('+t+")"))}else console.log('Could not load document "'+e._id+'" as it has no "type" field.')},_.__postInitialLoading=function(){angular.forEach(_.__containers,function(e){e.postInitialLoading()})}};return r}]),angular.module("SneakerJS").factory("SnjsBaseContainer",["$q",function(e){var t=function(){var e=this;e.__db=null},n=t.prototype;return n.postInitialLoading=function(){},n.clear=function(){},n.__postAndLoad=function(t){var n=this,i=e.defer();return n.__db.post(t).then(function(e){if(!e.ok)throw console.log(e),"Error fetching data";n.__db.get(e.id).then(function(e){i.resolve(n.loadDocumentFromDb(e))})}),i.promise},t}]),angular.module("SneakerJS").factory("SnjsCollection",["SnjsUtil","$q","SnjsBaseContainer",function(e,t,n){var i=e,o=function(e,t,n,i){var o=this,i=i||{};o.itemName=t,o.name=t,o.plural=i.plural||t+"s",o.dbDocumentType=i.dbDocumentType||t,o.__db=e,o.__proto=i.proto||function(){},o.__items={},o.__itemsAsArray=[],o.__parentRelationships={},o.__relationships=[],o.__fieldNames=n.slice(),o.__fullFieldNames=n.slice(),o.__fullFieldNames.push("_id"),o.__fullFieldNames.push("_rev")};i.inheritPrototype(o,n);var r=o.prototype;return r.registerChildRelationship=function(e){var t=this;t.__relationships.push(e)},r.registerParentRelationship=function(e,t,n){var i=this;i.__parentRelationships[n]=e,i.__relationships.push(e),i.__fullFieldNames.push(t)},r.registerManyToManyRelationship=function(e){var t=this;t.__relationships.push(e)},r.loadDocumentFromDb=function(e){var t=this,n=new t.__proto;return i.copyFields(e,n,t.__fullFieldNames),n.type=t.itemName,t.__items[e._id]=n,t.__itemsAsArray.push(n),n},r.clear=function(){var e=this;e.__items={},e.__itemsAsArray=[]},r.getAccessFunctionDefinitions=function(){var e=this,t=i.capitalizeFirstLetter,n=i.createAccessFunctionDefinition,o=t(e.itemName),r=t(e.plural);return[n("new"+o,e.newItem,!0),n("get"+o,e.getItem,!1),n("find"+r,e.findItems,!1),n("all"+r,e.allItems,!1)]},r.getItem=function(e){var t=this;return t.__items[e]},r.allItems=function(){var e=this;return e.__itemsAsArray},r.findItems=function(e){var t,n=this;if("function"==typeof e)t=e;else{if("object"!=typeof e)throw'Invalid argument for "find", must be an object or a function.';t=function(t){for(prop in e)if(t[prop]!==e[prop])return!1;return!0}}return i.filterIndex(n.__items,t)},r.newItem=function(e){var t=this,n={},o={};i.copyFields(e,n,t.__fieldNames),n.type=t.dbDocumentType;for(var r in t.__parentRelationships){var a=e[r],_=t.__parentRelationships[r].foreignKey;e[r]&&(n[_]=a._id,o[r]=a)}return t.__postAndLoad(n).then(function(e){for(var n in o)t.__parentRelationships[n].linkNewlyLoadedChildToParent(e,a);return e})},r.saveItem=function(e){var t=this,n={};return i.copyFields(e,n,t.__fullFieldNames),n.type=t.dbDocumentType,t.__db.put(n).then(function(t){return e._rev=t.rev,e._rev})},r.deleteItem=function(e){var n=this,o=n.__relationships.map(function(t){return t.respondToItemDeleted(e,n)});return t.all(o).then(function(){return n.__db.remove(e).then(function(t){delete n.__items[e._id],i.removeFromArray(n.__itemsAsArray,e)})})},o}]),angular.module("SneakerJS").factory("SnjsManyToManyRelationship",["$q","SnjsBaseContainer","SnjsUtil",function(e,t,n){var i=n,o=function(e,t,n,o){var r=this,o=o||{};r.__rightCollection=n,r.__leftCollection=t;var a=("lnk_"+t.itemName+"_"+n.itemName).toLowerCase();r.__functionNameEnd="",o.qualifier&&(r.__functionNameEnd="As"+i.capitalizeFirstLetter(o.qualifier),a+="_as_"+o.qualifier.toLowerCase()),r.dbDocumentType=o.dbDocumentType||a,r.name=r.dbDocumentType,r.__db=e,r.__leftCollection=t,r.__rightCollection=n,r.__leftRights={},r.__rightLefts={},r.__docsForReuse=[],n.registerManyToManyRelationship(r),t.registerManyToManyRelationship(r)};i.inheritPrototype(o,t);var r=o.prototype;return r.getAccessFunctionDefinitions=function(){var e=this,t=i.capitalizeFirstLetter,n=i.createAccessFunctionDefinition,o=t(e.__leftCollection.itemName),r=t(e.__leftCollection.plural),a=t(e.__rightCollection.itemName),_=t(e.__rightCollection.plural),s=e.__functionNameEnd,c="get"+o+_+s,l="get"+a+r+s,u="add"+o+a+s,d="remove"+o+a+s,f="is"+o+"LinkedTo"+a+s;return[n(c,e.getLeftRights,!1),n(l,e.getRightLefts,!1),n(u,e.addLink,!0),n(d,e.removeLink,!0),n(f,e.isLinked,!1)]},r.loadDocumentFromDb=function(e){var t=this;return e.right&&e.left&&t.__updateOneRegisterWithDocument(t.__leftRights,e.left,e.right,e)?(t.__updateOneRegisterWithDocument(t.__rightLefts,e.right,e.left,e),!0):(t.__sendDocumentToReusePile(e),!1)},r.clear=function(){var e=this;e.__leftRights={},e.__rightLefts={},e.__docsForReuse=[]},r.__updateOneRegisterWithDocument=function(e,t,n,i){var o=e[t];if(void 0===o){var r={};r[n]=i,e[t]={docs:r,items:[]}}else{if(o.docs[n])return!1;o.docs[n]=i}return!0},r.getLeftRights=function(e){var t=this;return t.__getInitialisedEntry(t.__leftRights,e._id).items},r.getRightLefts=function(e){var t=this;return t.__getInitialisedEntry(t.__rightLefts,e._id).items},r.addLink=function(t,n){var o=this;return o.isLinked(t,n)?e.when():o.__writeLinkToDatabase(t,n).then(function(){var e=o.__getInitialisedEntry(o.__leftRights,t._id),r=o.__getInitialisedEntry(o.__rightLefts,n._id);i.addUnique(e.items,n),i.addUnique(r.items,t)})},r.removeLink=function(e,t){var n=this,i=n.__getInitialisedEntry(n.__leftRights,e._id),o=n.__getInitialisedEntry(n.__rightLefts,t._id),r=n.__removeFromEntry(i,t),a=n.__removeFromEntry(o,e);if(r!==a)throw"This is strange...";return n.__db.remove(r)},r.__removeFromEntry=function(e,t){var n=e.docs[t._id];return i.removeFromArray(e.items,t),delete e.docs[t._id],n},r.isLinked=function(e,t){var n=this,o=n.__getInitialisedEntry(n.__leftRights,e._id);return i.arrayContains(o.items,t)},r.respondToItemDeleted=function(t,n){var i,o,r=this;n===r.__rightCollection?(o=!0,i=r.getRightLefts(t)):n===r.__leftCollection&&(o=!1,i=r.getLeftRights(t)),i=i.slice();var a=[];return angular.forEach(i,function(e){if(o)var n=e,i=t;else var n=t,i=e;a.push(r.removeLink(n,i))}),e.all(a)},r.__writeLinkToDatabase=function(t,n){function i(e){if(!e)throw"SnjsManyToManyRelationship.__writeLinkToDatabase failed to load document. This should not have happened.";r.resolve()}var o=this,r=e.defer(),a=o.__docsForReuse.pop();return a?(a.left=t._id,a.right=n._id,o.__db.put(a).then(function(e){a._rev=e.rev,i(o.loadDocumentFromDb(a))})):(a={left:t._id,right:n._id,type:o.dbDocumentType},o.__postAndLoad(a).then(function(e){i(e)})),r.promise},r.__sendDocumentToReusePile=function(e){var t=this;t.__docsForReuse.push(e)},r.__getInitialisedEntry=function(e,t){var n=this,i=e[t];if(void 0===i)i={docs:{},items:[]},e[t]=i;else if(i.items.length!==Object.keys(i.docs).length){var o=e===n.__leftRights?n.__rightCollection:n.__leftCollection;i.items.length=0,angular.forEach(i.docs,function(e,t){var n=o.getItem(t);n&&i.items.push(n)})}return i},o}]),angular.module("SneakerJS").factory("SnjsParentChildRelationship",["$q","SnjsBaseContainer","SnjsUtil",function(e,t,n){var i=n,o=function(e,t,n,i){var o=this,i=i||{};o.__db=e,o.__parentCollection=t,o.__childCollection=n,o.__childAlias=i.childAlias||n.plural,o.__parentAlias=i.parentAlias||t.itemName,o.__cascadeDelete=void 0===i.cascadeDelete?!0:i.cascadeDelete,o.__itemParent={},o.__itemChildren={},o.name="relationship_"+n.itemName+"_as_"+o.__childAlias+"_"+t.itemName+"_as_"+o.__parentAlias,o.foreignKey="fk__"+o.__parentAlias,t.registerChildRelationship(o),n.registerParentRelationship(o,o.foreignKey,o.__parentAlias)};i.inheritPrototype(o,t);var r=o.prototype;return r.getAccessFunctionDefinitions=function(){var e=this,t=i.capitalizeFirstLetter,n=i.createAccessFunctionDefinition,o=t(e.__childCollection.itemName),r=t(e.__childAlias),a=t(e.__parentCollection.itemName),_=t(e.__parentAlias);return[n("get"+o+_,e.getParent,!1),n("get"+a+r,e.getChildren,!1),n("set"+o+_,e.setChildParent,!0)]},r.postInitialLoading=function(){var e=this,t=e.foreignKey;angular.forEach(e.__parentCollection.__items,function(t){e.__itemChildren[t._id]=[]}),angular.forEach(e.__childCollection.__items,function(n){var i=n[t];if(i){var o=e.__parentCollection.getItem(i);e.linkNewlyLoadedChildToParent(n,o,i)}})},r.clear=function(){var e=this;e.__itemParent={},e.__itemChildren={}},r.linkNewlyLoadedChildToParent=function(e,t,n){var i=this,n=n||t._id;i.__itemParent[e._id]=t;var o=i.__itemChildren[n];void 0===o?i.__itemChildren[n]=[e]:o.push(e)},r.getParent=function(e){var t=this;return t.__itemParent[e._id]||null},r.getChildren=function(e){var t=this;return t.__itemChildren[e._id]||[]},r.setChildParent=function(e,t){var n=this,o=n.__itemParent[e._id],r=t?t._id:null;return o&&i.removeFromArray(n.__itemChildren[o._id],e),t&&(void 0===n.__itemChildren[t._id]?n.__itemChildren[t._id]=[e]:n.__itemChildren[t._id].push(e)),n.__itemParent[e._id]=t,e[n.foreignKey]=r,n.__childCollection.saveItem(e)},r.respondToItemDeleted=function(e,t){var n=this;return t===n.__parentCollection?n.__respondToParentDeleted(e):t===n.__childCollection?n.__respondToChildDeleted(e):void 0},r.__respondToParentDeleted=function(t){var n=this,o=n.__cascadeDelete?function(e){return n.__childCollection.deleteItem(e)}:function(e){return n.setChildParent(e,null)},r=n.getChildren(t).slice();return e.all(r.map(o)).then(function(){return delete n.__itemChildren[t._id],e.when(!0)},i.promiseFailed)},r.__respondToChildDeleted=function(t){var n=this,o=n.getParent(t);return o&&i.removeFromArray(n.__itemChildren[o._id],t),delete n.__itemParent[t._id],e.when(!0)},o}]),angular.module("SneakerJS").factory("SnjsSingleton",["SnjsUtil","SnjsBaseContainer",function(e,t){var n=e,i=function(e,t){var n=this;n.name=t,n.dbDocumentType="singleton__"+t,n.__db=e,n.__doc=null};n.inheritPrototype(i,t);var o=i.prototype;return o.loadDocumentFromDb=function(e){var t=this;if(null!==t.__doc)throw"found singleton of type "+t.name+" more than once in db";if(e._id!==t.dbDocumentType)throw"Expected singleton type "+t.name+" to have _id: "+t.dbDocumentType;return t.__doc=e,t.__doc.data},o.clear=function(){var e=this;e.__doc=null},o.getAccessFunctionDefinitions=function(){var e=this;return[n.createAccessFunctionDefinition("get"+n.capitalizeFirstLetter(e.name),e.getData,!1),n.createAccessFunctionDefinition("set"+n.capitalizeFirstLetter(e.name),e.setData,!1)]},o.getData=function(){var e=this;return e.__doc?e.__doc.data:{}},o.setData=function(e){var t=this;return t.__doc||(t.__doc={type:t.dbDocumentType,_id:t.dbDocumentType,data:{}}),angular.copy(e,t.__doc.data),t.__db.put(t.__doc).then(function(e){return t.__doc._rev=e.rev,e.rev})},i}]),angular.module("SneakerJS").service("SnjsUtil",["$q",function(e){var t=this;t.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t.createAccessFunctionDefinition=function(e,t,n){return{ModelFunctionName:e,containerFunction:t,queuedPromise:n}},t.arrayContains=function(e,t){for(var n=0,i=e.length;i>n;n++)if(t===e[n])return!0;return!1},t.addUnique=function(e,n){t.arrayContains(e,n)||e.push(n)},t.addAsItem=function(e,t,n){void 0===e[t]?e[t]=[n]:e[t].push(n)},t.removeFromArray=function(e,t){var n=e.indexOf(t);n>-1&&e.splice(n,1)},t.filterIndex=function(e,t){var n=[];return angular.forEach(e,function(e){t(e)&&n.push(e)}),n},t.inheritPrototype=function(e,t){var n=e.prototype,i=t.prototype;for(var o in i)"function"==typeof i[o]&&(n[o]=i[o])},t.copyFields=function(e,t,n){angular.forEach(n,function(n){t[n]=e[n]})},t.promiseFailed=function(e){console.log("Promise failed!"),console.log(e)}}]);
//# sourceMappingURL=sneakerjs.min.js.map
