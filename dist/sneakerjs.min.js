"use strict";angular.module("SneakerJS",[]),angular.module("SneakerJS").factory("BaseContainer",["$q",function(e){var t=function(){var e=this;e.__index=null,e.__db=null,e.dbDocumentType=null},n=t.prototype;return n.postInitialLoading=function(){},n.__postAndLoad=function(t){var n=this,i=e.defer();return n.__db.post(t).then(function(e){if(!e.ok)throw console.log(e),"Error fetching data";n.__db.get(e.id).then(function(e){i.resolve(n.loadDocumentFromDb(e))})}),i.promise},t}]),angular.module("SneakerJS").factory("Collection",["util","$q","BaseContainer",function(e,t,n){var i=function(e,t,n,i){var r=this,i=i||{};r.itemName=t,r.name=t,r.plural=i.plural||t+"s",r.dbDocumentType=i.dbDocumentType||t,r.__db=e,r.__proto=i.proto||function(){},r.__items={},r.__itemsAsArray=[],r.__parentRelationships={},r.__relationships=[],r.__fieldNames=n.slice(),r.__fullFieldNames=n.slice(),r.__fullFieldNames.push("_id"),r.__fullFieldNames.push("_rev")};e.inheritPrototype(i,n);var r=i.prototype;return r.registerChildRelationship=function(e){var t=this;t.__relationships.push(e)},r.registerParentRelationship=function(e,t,n){var i=this;i.__parentRelationships[n]=e,i.__relationships.push(e),i.__fullFieldNames.push(t)},r.registerManyToManyRelationship=function(e){var t=this;t.__relationships.push(e)},r.loadDocumentFromDb=function(t){var n=this,i=new n.__proto;return e.copyFields(t,i,n.__fullFieldNames),i.type=n.itemName,n.__items[t._id]=i,n.__itemsAsArray.push(i),i},r.getAccessFunctionDefinitions=function(){var t=this,n=e.capitalizeFirstLetter,i=e.createAccessFunctionDefinition,r=n(t.itemName),o=n(t.plural);return[i("new"+r,t.newItem,!0),i("get"+r,t.getItem,!1),i("find"+o,t.findItems,!1),i("all"+o,t.allItems,!1)]},r.getItem=function(e){var t=this;return t.__items[e]},r.allItems=function(){var e=this;return e.__itemsAsArray},r.findItems=function(t){var n,i=this;if("function"==typeof t)n=t;else{if("object"!=typeof t)throw'Invalid argument for "find", must be an object or a function.';n=function(e){for(prop in t)if(e[prop]!==t[prop])return!1;return!0}}return e.filterIndex(i.__items,n)},r.newItem=function(n){var i=this,r=t.defer(),o={},a={};e.copyFields(n,o,i.__fieldNames),o.type=i.dbDocumentType;for(var s in i.__parentRelationships){var l=n[s];n[s]&&(o[s]=l._id,a[s]=l)}return i.__postAndLoad(o).then(function(e){for(var t in a)i.__parentRelationships[t].linkNewlyLoadedChildToParent(e,l);r.resolve(e)}),r.promise},r.saveItem=function(n){var i=this,r=t.defer(),o={};return e.copyFields(n,o,i.__fullFieldNames),o.type=i.dbDocumentType,i.__db.put(o).then(function(e){n._rev=e.rev,r.resolve(n._rev)}),r.promise},r.deleteItem=function(n){var i=this,r=i.__relationships.map(function(e){return e.respondToItemDeleted(n,i)});return t.all(r).then(function(){i.__db.remove(n).then(function(t){delete i.__items[n._id],e.removeFromArray(i.__itemsAsArray,n)},e.promiseFailed)},e.promiseFailed)},i}]),angular.module("SneakerJS").factory("ManyToManyRelationship",["$q","BaseContainer","util",function(e,t,n){var i=function(e,t,i,r){var o=this,r=r||{};o.__rightCollection=i,o.__leftCollection=t;var a=("lnk_"+t.itemName+"_"+i.itemName).toLowerCase();o.__functionNameEnd="",r.qualifier&&(o.__functionNameEnd="As"+n.capitalizeFirstLetter(r.qualifier),a+="_as_"+r.qualifier.toLowerCase()),o.dbDocumentType=r.dbDocumentType||a,o.name=o.dbDocumentType,o.__db=e,o.__leftCollection=t,o.__rightCollection=i,o.__leftRights={},o.__rightLefts={},o.__docsForReuse=[],i.registerManyToManyRelationship(o),t.registerManyToManyRelationship(o)};n.inheritPrototype(i,t);var r=i.prototype;return r.getAccessFunctionDefinitions=function(){var e=this,t=n.capitalizeFirstLetter,i=n.createAccessFunctionDefinition,r=t(e.__leftCollection.itemName),o=t(e.__leftCollection.plural),a=t(e.__rightCollection.itemName),s=t(e.__rightCollection.plural),l=e.__functionNameEnd,u="get"+r+s+l,_="get"+a+o+l,c="add"+r+a+l,d="remove"+r+a+l,f="is"+r+"LinkedTo"+a+l;return[i(u,e.getLeftRights,!1),i(_,e.getRightLefts,!1),i(c,e.addLink,!0),i(d,e.removeLink,!0),i(f,e.isLinked,!1)]},r.loadDocumentFromDb=function(e){var t=this;return e.right&&e.left&&t.__updateOneRegisterWithDocument(t.__leftRights,e.left,e.right,e)?(t.__updateOneRegisterWithDocument(t.__rightLefts,e.right,e.left,e),!0):(t.__sendDocumentToReusePile(e),!1)},r.__updateOneRegisterWithDocument=function(e,t,n,i){var r=e[t];if(void 0===r){var o={};o[n]=i,e[t]={docs:o,items:[]}}else{if(r.docs[n])return!1;r.docs[n]=i}return!0},r.getLeftRights=function(e){var t=this;return t.__getInitialisedEntry(t.__leftRights,e._id).items},r.getRightLefts=function(e){var t=this;return t.__getInitialisedEntry(t.__rightLefts,e._id).items},r.addLink=function(t,i){var r=this;if(r.isLinked(t,i))return e.when();var o=e.defer();return r.__writeLinkToDatabase(t,i).then(function(){var e=r.__getInitialisedEntry(r.__leftRights,t._id),a=r.__getInitialisedEntry(r.__rightLefts,i._id);n.addUnique(e.items,i),n.addUnique(a.items,t),o.resolve()}),o.promise},r.removeLink=function(e,t){var n=this,i=n.__getInitialisedEntry(n.__leftRights,e._id),r=n.__getInitialisedEntry(n.__rightLefts,t._id),o=n.__removeFromEntry(i,t),a=n.__removeFromEntry(r,e);if(o!==a)throw"This is strange...";return n.__db.remove(o)},r.__removeFromEntry=function(e,t){var i=e.docs[t._id];return n.removeFromArray(e.items,t),delete e.docs[t._id],i},r.isLinked=function(e,t){var i=this,r=i.__getInitialisedEntry(i.__leftRights,e._id);return n.arrayContains(r.items,t)},r.respondToItemDeleted=function(t,n){var i,r,o=this;n===o.__rightCollection?(r=!0,i=o.getRightLefts(t)):n===o.__leftCollection&&(r=!1,i=o.getLeftRights(t)),i=i.slice();var a=[];return angular.forEach(i,function(e){if(r)var n=e,i=t;else var n=t,i=e;a.push(o.removeLink(n,i))}),e.all(a)},r.__writeLinkToDatabase=function(t,n){function i(e){if(!e)throw"ManyToManyRelationship.__writeLinkToDatabase failed to load document. This should not have happened.";o.resolve()}var r=this,o=e.defer(),a=r.__docsForReuse.pop();return a?(a.left=t._id,a.right=n._id,r.__db.put(a).then(function(e){a._rev=e.rev,i(r.loadDocumentFromDb(a))})):(a={left:t._id,right:n._id},r.__postAndLoad(a).then(function(e){i(e)})),o.promise},r.__sendDocumentToReusePile=function(e){var t=this;t.__docsForReuse.push(e)},r.__getInitialisedEntry=function(e,t){var n=this,i=e[t];if(void 0===i)i={docs:{},items:[]},e[t]=i;else if(i.items.length!==Object.keys(i.docs).length){var r=e===n.__leftRights?n.__rightCollection:n.__leftCollection;i.items.length=0,angular.forEach(i.docs,function(e,t){var n=r.getItem(t);n&&i.items.push(n)})}return i},i}]),angular.module("SneakerJS").service("model",["$q","Collection","ParentChildRelationship","ManyToManyRelationship",function(e,t,n,i){function r(e){var t=e.name;if(void 0!==m[t])throw"Trying to create two containers with the same name: "+t+" on model but it already exists.";m[t]=e,l(e),o(e)}function o(e){angular.forEach(e.getAccessFunctionDefinitions(),function(t){var n,i=t.ModelFunctionName;if(n=t.queuedPromise?s(e,t.containerFunction):a(e,t.containerFunction),void 0!==h[i])throw"Container "+e.name+" trying to create function "+i+" on model but it already exists.";h[i]=n})}function a(e,t){return function(){return t.apply(e,arguments)}}function s(t,n){return function(){var i=arguments,r=e.defer();return v.then(function(){v=n.apply(t,i),v.then(function(e){r.resolve(e)})}),r.promise}}function l(e){var t=e.dbDocumentType;if(void 0!==t){if(t in p){p[t];throw'More than one container attempting to register database document type: "'+t+'".'}p[t]=e}}function u(){var t=e.defer(),n=f();return n.then(function(e){angular.forEach(e.rows,function(e){_(e.doc)}),c(),t.resolve()})["catch"](function(e){console.log(e)}),t.promise}function _(e){var t=e.type;if(t){var n=p[t];n?n.loadDocumentFromDb(e,t):(console.log(e),console.log('Could not load document "'+e._id+'" as type was not recognised ('+t+")"))}else console.log('Could not load document "'+e._id+'" as it has no "type" field.')}function c(){angular.forEach(m,function(e){e.postInitialLoading()})}var d,f,h=this,m={},p={},v=e.when();h.initialize=function(e,t){d=e,f=t||function(){return d.allDocs({include_docs:!0,attachments:!1})}};var g;h.dataReady=function(){return void 0===g&&(g=e.defer(),u().then(function(){g.resolve()})),g.promise},h.printInfo=function(){angular.forEach(m,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("model."+e.ModelFunctionName)})})},h.collection=function(e,n,i){var o=new t(d,e,n,i);return r(o),o},h.join=function(e,t,o){var a,o=o||{},s=o.type||"parentChild";if(angular.forEach([e,t],function(e){if(void 0===m[e])throw'Failed to create join, container not found: "'+e+'" '}),"parentChild"===s){var l=m[e],u=m[t];a=new n(d,l,u,o)}else{if("manyToMany"!==s)throw'"'+s+'" is not a valid relationship type';var _=m[e],c=m[t];a=new i(d,_,c,o)}return r(a),a},h.saveItem=function(e){return m[e.type].saveItem(e)},h.deleteItem=function(e){return m[e.type].deleteItem(e)}}]),angular.module("SneakerJS").factory("ParentChildRelationship",["$q","BaseContainer","ValueRegister","util",function(e,t,n,i){var r=function(e,t,i,r){var o=this,r=r||{};o.__db=e,o.__parentCollection=t,o.__childCollection=i,o.__childAlias=r.childAlias||i.plural,o.__parentAlias=r.parentAlias||t.itemName,o.__parentDeleteInProgress=new n,o.__cascadeDelete=void 0===r.cascadeDelete?!0:r.cascadeDelete,o.__itemParent={},o.__itemChildren={},o.name="relationship_"+i.itemName+"_as_"+o.__childAlias+"_"+t.itemName+"_as_"+o.__parentAlias,o.foreignKey="fk__"+o.__parentAlias,t.registerChildRelationship(o),i.registerParentRelationship(o,o.foreignKey,o.__parentAlias)};i.inheritPrototype(r,t);var o=r.prototype;return o.getAccessFunctionDefinitions=function(){var e=this,t=i.capitalizeFirstLetter,n=i.createAccessFunctionDefinition,r=t(e.__childCollection.itemName),o=t(e.__childAlias),a=t(e.__parentCollection.itemName),s=t(e.__parentAlias);return[n("get"+r+s,e.getParent,!1),n("get"+a+o,e.getChildren,!1),n("set"+r+s,e.setChildParent,!0)]},o.postInitialLoading=function(){var e=this,t=e.foreignKey;angular.forEach(e.__parentCollection.__items,function(t){e.__itemChildren[t._id]=[]}),angular.forEach(e.__childCollection.__items,function(n){var i=n[t];if(i){var r=e.__parentCollection.getItem(i);e.linkNewlyLoadedChildToParent(n,r,i)}})},o.linkNewlyLoadedChildToParent=function(e,t,n){var i=this,n=n||t._id;i.__itemParent[e._id]=t;var r=i.__itemChildren[n];void 0===r?i.__itemChildren[n]=[e]:r.push(e)},o.getParent=function(e){var t=this;return t.__itemParent[e._id]||null},o.getChildren=function(e){var t=this;return t.__itemChildren[e._id]||[]},o.setChildParent=function(e,t){var n=this,r=n.__itemParent[e._id],o=t?t._id:null;return r&&i.removeFromArray(n.__itemChildren[r._id],e),t&&(void 0===n.__itemChildren[t._id]?n.__itemChildren[t._id]=[e]:n.__itemChildren[t._id].push(e)),n.__itemParent[e._id]=t,e[n.foreignKey]=o,n.__childCollection.saveItem(e)},o.respondToItemDeleted=function(e,t){var n=this;return t===n.__parentCollection?n.__respondToParentDeleted(e):t===n.__childCollection?n.__respondToChildDeleted(e):void 0},o.__respondToParentDeleted=function(t){var n=this,r=n.__cascadeDelete?function(e){return n.__childCollection.deleteItem(e)}:function(e){return n.setChildParent(e,null)},o=n.getChildren(t).slice();return e.all(o.map(r)).then(function(){return delete n.__itemChildren[t._id],e.when(!0)},i.promiseFailed)},o.__respondToChildDeleted=function(t){var n=this,r=n.getParent(t);return r&&i.removeFromArray(n.__itemChildren[r._id],t),delete n.__itemParent[t._id],e.when(!0)},r}]),angular.module("SneakerJS").factory("QueuedResponseDb",["$q","ValueRegister",function(e,t){var n=function(t){var n=this;n._db=t,n.queue={},n._nextId=0,n._latestResolvedId=1,n.wrapPromise=function(t,i){var r=n.nextId(),o=n._db[t](i),a=e.defer();return n.queuePromise(r,a),o.then(function(e){n.promiseGotResolved(r,e)}),a.promise},angular.forEach(["post","put","get","remove"],function(e){n[e]=function(t){return n.wrapPromise(e,t)}})};return n.prototype.nextId=function(){return this._nextId++,this._nextId},n.prototype.queuePromise=function(e,t){this.queue[e]={returnPromise:t,resolved:!1}},n.prototype.promiseGotResolved=function(e,t){var n=this.queue[e];n.result=t,n.resolved=!0,this.releasResolvedPromises()},n.prototype.releasResolvedPromises=function(){for(var e=!1;!e;)entry=this.queue[this._latestResolvedId],entry&&entry.resolved?(entry.returnPromise.resolve(entry.result),this._latestResolvedId++):e=!0},n}]),angular.module("SneakerJS").service("util",["$q",function(e){var t=this;t.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t.createAccessFunctionDefinition=function(e,t,n){return{ModelFunctionName:e,containerFunction:t,queuedPromise:n}},t.arrayContains=function(e,t){for(var n=0,i=e.length;i>n;n++)if(t===e[n])return!0;return!1},t.addUnique=function(e,n){t.arrayContains(e,n)||e.push(n)},t.addAsItem=function(e,t,n){void 0===e[t]?e[t]=[n]:e[t].push(n)},t.removeFromArray=function(e,t){var n=e.indexOf(t);n>-1&&e.splice(n,1)},t.filterIndex=function(e,t){var n=[];return angular.forEach(e,function(e){t(e)&&n.push(e)}),n},t.inheritPrototype=function(e,t){var n=e.prototype,i=t.prototype;for(var r in i)"function"==typeof i[r]&&(n[r]=i[r])},t.copyFields=function(e,t,n){angular.forEach(n,function(n){t[n]=e[n]})},t.promiseFailed=function(e){console.log("Promise failed!"),console.log(e)}}]),angular.module("SneakerJS").factory("ValueRegister",function(){var e=function(){this._register={}};return e.prototype.set=function(e,t){this._register[e]=t},e.prototype.get=function(e){return this._register[e]},e});
//# sourceMappingURL=sneakerjs.min.js.map
